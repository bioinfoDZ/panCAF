library(dplyr)
library(Seurat)
library(ggplot2)
library(umap)
library(hypeR)
library(msigdbr)
library(pheatmap)

#GSE72056 (MEL)
gse72056_all_cells_cafs <- read.table(file.choose(), header = T, row.names = 1, sep = '\t')
GSE72056_melanoma_cafs <- CreateSeuratObject(counts = gse72056_all_cells_cafs, project = "GSE72056_CAF_Melanoma")
dim(GSE72056_melanoma_cafs) #results are 61 cells and 14494 features
GSE72056_melanoma_cafs[["percent.mt"]] <- PercentageFeatureSet(GSE72056_melanoma_cafs, pattern = "^MT-")
VlnPlot(GSE72056_melanoma_cafs, features = c("nFeature_RNA", "nCount_RNA", "percent.mt"), ncol = 3)
plot1 <- FeatureScatter(GSE72056_melanoma_cafs, feature1 = "nCount_RNA", feature2 = "percent.mt")
plot2 <- FeatureScatter(GSE72056_melanoma_cafs, feature1 = "nCount_RNA", feature2 = "nFeature_RNA")
CombinePlots(plots = list(plot2))
GSE72056_melanoma_cafs <- FindVariableFeatures(GSE72056_melanoma_cafs, selection.method = "vst", nfeatures = 2000)
top10 <- head(VariableFeatures(GSE72056_melanoma_cafs), 10)
plot1 <- VariableFeaturePlot(GSE72056_melanoma_cafs)
plot2 <- LabelPoints(plot = plot1, points = top10, repel = TRUE)
CombinePlots(plots = list(plot2))
all.genes <- rownames(GSE72056_melanoma_cafs)
GSE72056_melanoma_cafs <- ScaleData(GSE72056_melanoma_cafs, features = all.genes)
GSE72056_melanoma_cafs <- RunPCA(GSE72056_melanoma_cafs, features = VariableFeatures(object = GSE72056_melanoma_cafs))
DimHeatmap(GSE72056_melanoma_cafs, dims = 1:10, cells = 500, balanced = TRUE)
DimHeatmap(GSE72056_melanoma_cafs, dims = 11:20, cells = 500, balanced = TRUE)
DimHeatmap(GSE72056_melanoma_cafs, dims = 21:30, cells = 500, balanced = TRUE)
DimHeatmap(GSE72056_melanoma_cafs, dims = 31:40, cells = 500, balanced = TRUE)
DimHeatmap(GSE72056_melanoma_cafs, dims = 41:50, cells = 500, balanced = TRUE)
GSE72056_melanoma_cafs <- JackStraw(GSE72056_melanoma_cafs, num.replicate = 100)
GSE72056_melanoma_cafs <- ScoreJackStraw(GSE72056_melanoma_cafs, dims = 1:20)
JackStrawPlot(GSE72056_melanoma_cafs, dims = 1:20)
ElbowPlot(GSE72056_melanoma_cafs, ndims = 50, reduction = "pca")
GSE72056_melanoma_cafs <- FindNeighbors(GSE72056_melanoma_cafs, dims = 1:7)
GSE72056_melanoma_cafs_resolution_0.5 <- FindClusters(GSE72056_melanoma_cafs, resolution = 0.5)
GSE72056_melanoma_cafs_resolution_0.5 <- RunUMAP(GSE72056_melanoma_cafs_resolution_0.5, dims = 1:7)
DimPlot(GSE72056_melanoma_cafs_resolution_0.5, reduction = "umap")
GSE72056_melanoma_cafs_resolution_0.5.markers <- FindAllMarkers(GSE72056_melanoma_cafs_resolution_0.5, only.pos = TRUE, min.pct = 0.25, logfc.threshold = 0.25)
GSE72056_melanoma_cafs_resolution_0.5.markers %>% group_by(cluster) %>% top_n(n = 2, wt = avg_logFC)
GSE72056_melanoma_cafs_resolution_0.5.markers_top20 <- GSE72056_melanoma_cafs_resolution_0.5.markers %>% group_by(cluster) %>% top_n(n = 20, wt = avg_logFC)
DoHeatmap(GSE72056_melanoma_cafs_resolution_0.5, features = GSE72056_melanoma_cafs_resolution_0.5.markers_top20$gene, label = F) + NoLegend() + scale_fill_gradientn(colors = c("blue", "white", "red"), na.value = "white")
feature <- c('C3', 'C1S', 'C7', 'CXCL14', 'MKI67', 'TOP2A', 'BIRC4')
mel_dot_plot <- DotPlot(GSE72056_melanoma_cafs_resolution_0.5, features = feature, cols = c("lightgrey", "red")) + RotatedAxis()

#GSE103322(HNSC)
gse103322_cafs <- read.table(file.choose(), header = T, row.names = 1, sep = '\t')
GSE103322_hnsc_cafs <- CreateSeuratObject(counts = gse103322_cafs, project = "GSE103322_CAF_HNSC")
dim(GSE103322_hnsc_cafs)
GSE103322_hnsc_cafs[["percent.mt"]] <- PercentageFeatureSet(GSE103322_hnsc_cafs, pattern = "^MT-")
VlnPlot(GSE103322_hnsc_cafs, features = c("nFeature_RNA", "nCount_RNA", "percent.mt"), ncol = 3)
plot1 <- FeatureScatter(GSE103322_hnsc_cafs, feature1 = "nCount_RNA", feature2 = "percent.mt")
plot2 <- FeatureScatter(GSE103322_hnsc_cafs, feature1 = "nCount_RNA", feature2 = "nFeature_RNA")
CombinePlots(plots = list(plot2))
GSE103322_hnsc_cafs <- FindVariableFeatures(GSE103322_hnsc_cafs, selection.method = "vst", nfeatures = 2000)
top10 <- head(VariableFeatures(GSE103322_hnsc_cafs), 10)
plot1 <- VariableFeaturePlot(GSE103322_hnsc_cafs)
plot2 <- LabelPoints(plot = plot1, points = top10, repel = TRUE)
CombinePlots(plots = list(plot2))
all.genes <- rownames(GSE103322_hnsc_cafs)
GSE103322_hnsc_cafs <- ScaleData(GSE103322_hnsc_cafs, features = all.genes)
GSE103322_hnsc_cafs <- RunPCA(GSE103322_hnsc_cafs, features = VariableFeatures(object = GSE103322_hnsc_cafs))
DimHeatmap(GSE103322_hnsc_cafs, dims = 1:10, cells = 500, balanced = TRUE)
DimHeatmap(GSE103322_hnsc_cafs, dims = 11:20, cells = 500, balanced = TRUE)
DimHeatmap(GSE103322_hnsc_cafs, dims = 21:30, cells = 500, balanced = TRUE)
DimHeatmap(GSE103322_hnsc_cafs, dims = 31:40, cells = 500, balanced = TRUE)
DimHeatmap(GSE103322_hnsc_cafs, dims = 41:50, cells = 500, balanced = TRUE)
GSE103322_hnsc_cafs <- JackStraw(GSE103322_hnsc_cafs, num.replicate = 100)
GSE103322_hnsc_cafs <- ScoreJackStraw(GSE103322_hnsc_cafs, dims = 1:20)
JackStrawPlot(GSE103322_hnsc_cafs, dims = 1:17)
ElbowPlot(GSE103322_hnsc_cafs, ndims = 50, reduction = "pca")
GSE103322_hnsc_cafs <- FindNeighbors(GSE103322_hnsc_cafs, dims = 1:17)
GSE103322_hnsc_cafs_resolution_0.3 <- FindClusters(GSE103322_hnsc_cafs, resolution = 0.3)
GSE103322_hnsc_cafs_resolution_0.3 <- RunUMAP(GSE103322_hnsc_cafs_resolution_0.3, dims = 1:17)
DimPlot(GSE103322_hnsc_cafs_resolution_0.3, reduction = "umap")
GSE103322_hnsc_cafs_resolution_0.3.markers <- FindAllMarkers(GSE103322_hnsc_cafs_resolution_0.3, only.pos = TRUE, min.pct = 0.25, logfc.threshold = 0.25)
GSE103322_hnsc_cafs_resolution_0.3.markers %>% group_by(cluster) %>% top_n(n = 2, wt = avg_logFC)
GSE103322_hnsc_cafs_resolution_0.3.markers_top20 <- GSE103322_hnsc_cafs_resolution_0.3.markers %>% group_by(cluster) %>% top_n(n = 20, wt = avg_logFC)
DoHeatmap(GSE103322_hnsc_cafs_resolution_0.3, features = GSE103322_hnsc_cafs_resolution_0.3.markers_top20$gene, label = F) + NoLegend() + scale_fill_gradientn(colors = c("blue", "white", "red"), na.value = "white")
feature <- c('ACTA2', 'MYH11', 'TAGLN', 'MYL9', 'MYLK', 'COL1A1', 'COL1A2', 'COL3A1', 'MMP11', 'MMP19', 'C3', 'CXCL12', 'CXCL14', 'MYF5', 'MYF6', 'HAS1', 'COMP', 'FN1', 'COL10A1')
hnscc_dot_plot <- DotPlot(GSE103322_CAFs_resolution_0.3, features = feature, cols = c("lightgrey", "red")) + RotatedAxis()

#E-MTB_6149 (LC)
LC_cafs <- readRDS(file.choose())
LC_cafs <- CreateSeuratObject(counts = LC_cafs, project = "CAF_LC")
dim(LC_cafs)
LC_cafs[["percent.mt"]] <- PercentageFeatureSet(LC_cafs, pattern = "^MT-")
VlnPlot(LC_cafs, features = c("nFeature_RNA", "nCount_RNA", "percent.mt"), ncol = 3)
plot1 <- FeatureScatter(LC_cafs, feature1 = "nCount_RNA", feature2 = "percent.mt")
plot2 <- FeatureScatter(LC_cafs, feature1 = "nCount_RNA", feature2 = "nFeature_RNA")
CombinePlots(plots = list(plot2))
LC_cafs <- FindVariableFeatures(LC_cafs, selection.method = "vst", nfeatures = 2000)
top10 <- head(VariableFeatures(LC_cafs), 10)
plot1 <- VariableFeaturePlot(LC_cafs)
plot2 <- LabelPoints(plot = plot1, points = top10, repel = TRUE)
CombinePlots(plots = list(plot2))
all.genes <- rownames(LC_cafs)
LC_cafs <- ScaleData(LC_cafs, features = all.genes)
LC_cafs <- RunPCA(LC_cafs, features = VariableFeatures(object = LC_cafs))
DimHeatmap(LC_cafs, dims = 1:10, cells = 500, balanced = TRUE)
DimHeatmap(LC_cafs, dims = 11:20, cells = 500, balanced = TRUE)
DimHeatmap(LC_cafs, dims = 21:30, cells = 500, balanced = TRUE)
DimHeatmap(LC_cafs, dims = 31:40, cells = 500, balanced = TRUE)
DimHeatmap(LC_cafs, dims = 41:50, cells = 500, balanced = TRUE)
LC_cafs <- JackStraw(LC_cafs, num.replicate = 100)
LC_cafs <- ScoreJackStraw(LC_cafs, dims = 1:20)
JackStrawPlot(LC_cafs, dims = 1:20)
ElbowPlot(LC_cafs, ndims = 50, reduction = "pca")
LC_cafs <- FindNeighbors(LC_cafs, dims = 1:20)
LC_cafs <- FindClusters(LC_cafs, resolution = 0.15)
LC_cafs <- RunUMAP(LC_cafs, dims = 1:20)
DimPlot(LC_cafs, reduction = "umap")
LC_cafs.markers <- FindAllMarkers(LC_cafs, only.pos = TRUE, min.pct = 0.25, logfc.threshold = 0.25)
LC_cafs.markers %>% group_by(cluster) %>% top_n(n = 2, wt = avg_logFC)
LC_cafs.markers_top20 <- LC_cafs %>% group_by(cluster) %>% top_n(n = 20, wt = avg_logFC)
DoHeatmap(LC_cafs, features = LC_cafs.markers_top20$gene, label = F) + NoLegend() + scale_fill_gradientn(colors = c("blue", "white", "red"), na.value = "white")
feature <- c('COL1A1', 'COL1A2', 'COL3A1', 'COL8A1', 'ACTA2', 'MYH11', 'CFD', 'IL6', 'CCL2', 'CXCL2', 'EEF1A1', 'RPL17')
LC_dot_plot <- DotPlot(LC_cafs, features = feature, cols = c("lightgrey", "red")) + RotatedAxis()




